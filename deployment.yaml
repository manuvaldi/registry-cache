apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: registry-cache
  name: registry-cache
spec:
  replicas: 1
  selector:
    matchLabels:
      app: registry-cache
  template:
    metadata:
      labels:
        app: registry-cache
      name: registry-cache
    spec:
      volumes:
      - name: pull-secret
        hostPath:
          path: /opt/registry/pull-secret.json
      - name: certs
        hostPath:
          path: /opt/registry/certs
          type: Directory
      - name: data
        hostPath:
          path: /opt/registry/data
          type: Directory
      restartPolicy: Always
      containers:
      - name: toolbox
        image: quay.io/mvalledi/registry-cache-toolbox:latest
        volumeMounts:
        - name: data
          mountPath: /var/lib/registry
      - name: registry
        imagePullPolicy: Always
        image: quay.io/mvalledi/registry-cache-toolbox:latest
        command: ["/bin/sh","-c"]
        args: ["sh /toolbox/generate-config.sh && registry serve /etc/docker/registry/config.yml"]
        env:
        - name: REGISTRY_HTTP_TLS_CERTIFICATE
          value: "/certs/domain2.crt"
        - name: REGISTRY_HTTP_TLS_KEY
          value: "/certs/domain2.key"
        - name: REGISTRY_STORAGE_DELETE_ENABLED
          value: 'true'
        ports:
        - name: registry-proxy
          containerPort: 5000
          hostPort: 5002
        hostNetwork: true
        volumeMounts:
        - name: pull-secret
          mountPath: /pull-secret.json
        - name: certs
          mountPath: /certs
        - name: data
          mountPath: /var/lib/registry
